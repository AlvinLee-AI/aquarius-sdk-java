## Dealing with expired PGP signing keys

The PGP key used to sign Maven Central Repository assets will expire from time to time.

Typically, the expiry date needs to be pushed out every two years.

This is the third time I've had to deal with an expired key, and after a struggle (AGAIN!) I decided to document the procedure and make future me (or future you) more happy! You're welcome.

## Secrets aren't stored here in the git repo

Check the `OpenSource@AquaticInformatics.com` LastPass entry for the actual secrets and passphrases.

This document will just contain placeholders, in `{LastPass:SYMBOL}` notation.

## When the PGP key expires

You'll notice the Appveyor `master` build is failing in the `maven-gpg-plugin:1.6:sign (sign artifacts)` goal.

[![Build status](https://ci.appveyor.com/api/projects/status/nlhcrayb3jm9mntq/branch/master?svg=true)](https://ci.appveyor.com/project/SystemsAdministrator/aquarius-sdk-java-p7vvi/branch/master)

### Step 1 - Update the PGP private key expiry date

Follow the steps in [this article](https://central.sonatype.org/publish/requirements/gpg/#dealing-with-expired-keys).

The basic commands are:

```shell script
$ gpg --list-keys
  /c/Users/{FutureYou}/.gnupg/pubring.kbx
  ----------------------------------------
  pub   rsa2048 2017-08-28 [SC] [expired: 2021-02-16]
        {really-long-hex-string}
  uid           [ expired] Open Source Aquatics (OpenSource-AI) <opensource@aquaticinformatics.com>

$ gpg --edit-key {really-long-hex-string}
gpg> 1
gpg> expire
Key is valid for? 2y
gpg> save

$ gpg --keyserver keyserver.ubuntu.com --send-keys {really-long-hex-string}
```

### Step 2 - Use the `{LastPass:APPVEYOR_SECRET}` to re-encrypt the Maven build files

Four `*.enc` files will be generated by AppVeyor's [`secure-file`](https://github.com/appveyor/secure-file) tool.

Four new unique salt values will be written to stdout as well. We'll need to capture these salts for later.

```shell script
$ cd {repo}/build/Maven
$ ./collect_encrypted_files.sh "{LastPass:APPVEYOR_SECRET}"
Encrypting OpenSourceAquatics.secret.gpg.asc
Salt: {secret_gpg_salt value to be encrypted in Step 3}
Encrypting OpenSourceAquatics.public.gpg.asc
Salt: {public_gpg_salt value to be encrypted in Step 3}
Encrypting C:\Users\{FutureYou}/.m2/settings-security.xml but really just settings-security.xml
Salt: {settings_security_salt value to be encrypted in Step 3}
Encrypting C:\Users\{FutureYou}/.m2/settings.xml but really just settings.xml
Salt: {settings_salt value to be encrypted in Step 3}
```

### Step 3 - Update the four salts in [appveyor-mvm-release.yml](https://github.com/AquaticInformatics/aquarius-sdk-java/blob/master/appveyor-mvn-release.yml#L38-L49)

Use the `AppVeyor => Account => Encrypt YAML` page to encrypt each of the four salts from the Step 2 output into secure variables.

Store the encrypted salt values in the `appveypr-mvm-release.yml`

### Step 4 - Commit the updated files

Your git commit should include updates to these five files:
```
appveyor-mvn-release.yml
build/Maven/OpenSourceAquatics.public.gpg.asc.enc
build/Maven/OpenSourceAquatics.secret.gpg.asc.enc
build/Maven/settings-security.xml.enc
build/Maven/settings.xml.enc
```

### Step 5 - Raise a pull request

Now just raise a pull request, merge it, and the repo should be ready to be built and deployed to Maven Central with signed artifacts.
